<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Expense Tracker Dashboard</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="/css/dashboardstyles.css" />
  </head>
  <body>
    <aside>
      <div>
        <h1>Expense Tracker</h1>
        <div class="nav-link active">Dashboard</div>
        <div class="nav-link">Income</div>
        <div class="nav-link">Expense</div>
      </div>
      <button class="user-btn">User</button>
    </aside>

    <main>
      <div class="card-container">
        <!-- Income Card -->
        <div class="card" style="max-height: 220px; overflow-y: auto">
          <h3 class="summary-heading">Total Balance</h3>
          <div class="item-cards">
            <div class="summary-text">$300</div>
          </div>
        </div>
        <!-- Income Card -->
        <div class="card" style="max-height: 220px; overflow-y: auto">
          <h3 class="summary-heading">Montly Income</h3>
          <div class="item-cards">
            <div class="summary-text green">$300</div>
          </div>
        </div>

        <!-- Expenses Card -->
        <div class="card" style="max-height: 220px; overflow-y: auto">
          <h3 class="summary-heading">Monthly Expense</h3>
          <div class="item-cards">
            <div class="summary-text red">$300</div>
          </div>
        </div>
      </div>
      <h2 class="section-title">Transaction</h2>

      <!-- Top Section -->
      <div class="card-container">
        <!-- Recent Expenses -->
        <div class="card">
          <h3>Recent Transaction</h3>
          <div class="item-cards" id="recent-transaction">
            <div class="item-card income">
              🍕 Food - $15 <small>Apr 28</small>
            </div>
            <div class="item-card expense">
              🚌 Transport - $5 <small>Apr 27</small>
            </div>

            <div class="item-card">
              📚 Education - $30 <small>Apr 24</small>
            </div>
            <div class="item-card">🏠 Rent - $100 <small>Apr 23</small></div>
          </div>
        </div>

        <!-- Top Categories -->
        <div class="card">
          <h3>Top Categories</h3>
          <div class="item-cards" id="top-category"></div>
            <div class="item-card income">🏠 Rent - $100</div>
            <div class="item-card expense">📚 Education - $30</div>
            <div class="item-card">🎮 Entertainment - $20</div>
          </div>
        </div>
      </div>

      <!-- All Expenses -->
      <div class="all-expenses">
        <div class="all-expenses-header">
          <h3>All Transaction</h3>
          <span>Sort By ▾</span>
        </div>
        <div class="item-cards">
          <div class="item-card">🍕 Food - $15 <small>Apr 28</small></div>
          <div class="item-card">🚌 Transport - $5 <small>Apr 27</small></div>
          <div class="item-card">📱 Recharge - $10 <small>Apr 27</small></div>
          <div class="item-card">💊 Health - $12 <small>Apr 26</small></div>
          <div class="item-card">
            🎮 Entertainment - $20 <small>Apr 25</small>
          </div>
          <div class="item-card">📚 Education - $30 <small>Apr 24</small></div>
          <div class="item-card">🏠 Rent - $100 <small>Apr 23</small></div>
        </div>
      </div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
      // Check if token exists
      const token = localStorage.getItem("token");
      if (!token) {
        window.location.href = "/login.html";
      }

      // Setup axios with authorization header
      axios.defaults.headers.common["Authorization"] = `Bearer ${token}`;

      // Function to load summary data
      async function loadSummaryData() {
        try {
          const response = await axios.get("/api/summary");
          const { totalIncome, totalExpense, totalbalance } = response.data;

          // Update the UI
          document.querySelector(
            ".card:nth-child(1) .summary-text"
          ).textContent = `$${totalbalance}`;
          document.querySelector(
            ".card:nth-child(2) .summary-text"
          ).textContent = `$${totalIncome}`;
          document.querySelector(
            ".card:nth-child(3) .summary-text"
          ).textContent = `$${totalExpense}`;
        } catch (error) {
          console.error("Error loading summary data:", error);
          if (error.response && error.response.status === 401) {
            // Token expired or invalid
            localStorage.removeItem("token");
            window.location.href = "/login.html";
          }
        }
      }

      // Function to load recent transactions
      async function loadRecentTransactions() {
        try {
          // Get expenses
          const expensesResponse = await axios.get("/api/expenses");
          const expenses = expensesResponse.data;

          // Get income
          const incomeResponse = await axios.get("/api/income");
          const incomes = incomeResponse.data;

          // Combine and sort by date
          const transactions = [
            ...expenses.map((e) => ({ ...e, type: "expense" })),
            ...incomes.map((i) => ({ ...i, type: "income" })),
          ].sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
          // console.log(transactions);

          // Get the recent transactions container
          const recentTransactionsContainer = document.querySelector(
            ".card:nth-child(1) #recent-transaction"
          );
          recentTransactionsContainer.innerHTML = ""; // Clear existing content

          // Display recent transactions (limit to 5)
          const recentTransactions = transactions.slice(0, 5);
          recentTransactions.forEach((transaction) => {
            const date = new Date(transaction.createdAt).toLocaleDateString(
              "en-US",
              { month: "short", day: "numeric" }
            );
            const amount = transaction.Amount;
            const category = transaction.Category;
            const type = transaction.type;

            // Create and add the transaction element
            const transactionElement = document.createElement("div");
            transactionElement.className = `item-card ${type}`;
            transactionElement.innerHTML = `
              ${getCategoryEmoji(
                category
              )} ${category} - $${amount} <small>${date}</small>
            `;

            recentTransactionsContainer.appendChild(transactionElement);
          });

          // Also update the all transactions section
          const allTransactionsContainer = document.querySelector(
            ".all-expenses .item-cards"
          );
          allTransactionsContainer.innerHTML = ""; // Clear existing content

          transactions.forEach((transaction) => {
            const date = new Date(transaction.createdAt).toLocaleDateString(
              "en-US",
              { month: "short", day: "numeric" }
            );
            const amount = transaction.Amount;
            const category = transaction.Category;
            const type = transaction.type;

            // Create and add the transaction element
            const transactionElement = document.createElement("div");
            transactionElement.className = `item-card ${type}`;
            transactionElement.innerHTML = `
              ${getCategoryEmoji(
                category
              )} ${category} - $${amount} <small>${date}</small>
            `;

            allTransactionsContainer.appendChild(transactionElement);
          });
        } catch (error) {
          console.error("Error loading transactions:", error);
        }
      }

      async function loadTopCategories() {
        const categories = [
          "Food",
          "Transportation",
          "Health",
          "Entertainment",
          "Shopping",
          "Insurance",
          "Misc",
          "Personal",
          "Salary",
          "Business",
          "Gifts",
          "Interest",
          "Allowance",
          "Other",
        ];
        const categoriesSum = {
          // Expense categories
          Food: 0,
          Transportation: 0,
          Health: 0,
          Entertainment: 0,
          Shopping: 0,
          Insurance: 0,
          Misc: 0,
          Personal: 0,

          // Income categories
          Salary: 0,
          Business: 0,
          Gifts: 0,
          Interest: 0,
          Allowance: 0,
          Other: 0,
        };
        try {
          const expensesResponse = await axios.get("/api/expenses");
          const expenses = expensesResponse.data;

          // Get income
          const incomeResponse = await axios.get("/api/income");
          const incomes = incomeResponse.data;

          // console.log(expenses);
          const transactions = [
            ...expenses.map((e) => ({ ...e, type: "expense" })),
            ...incomes.map((i) => ({ ...i, type: "income" })),
          ];

          transactions.forEach((transaction) => {
            cat = transaction.Category;

            // console.log(categoriesSum.Category);
            categoriesSum[cat] += transaction.Amount;
          });

          //sort
          console.log(categoriesSum);
          const sorted = Object.entries(categoriesSum).sort(
            (a, b) => b[1] - a[1]
          );
          console.log(sorted);

          const topCategory = sorted.slice(0, 3);
          console.log(topCategory);
        
        } catch {}
      }
      // Helper function to get emoji for category
      function getCategoryEmoji(category) {
        const emojis = {
          // Expense categories
          Food: "🍕",
          Transportation: "🚌",
          Health: "💊",
          Entertainment: "🎮",
          Shopping: "🛍️",
          Insurance: "📝",
          Misc: "📦",
          Personal: "👤",

          // Income categories
          Salary: "💰",
          Business: "💼",
          Gifts: "🎁",
          Interest: "💹",
          Allowance: "💵",
          Other: "🔄",
        };

        return emojis[category] || "📊";
      }

      // Load data when page loads
      window.addEventListener("DOMContentLoaded", () => {
        loadSummaryData();
        loadRecentTransactions();
        loadTopCategories();

        // Add logout functionality
        document.querySelector(".user-btn").addEventListener("click", () => {
          localStorage.removeItem("token");
          window.location.href = "/login.html";
        });
      });
    </script>
  </body>
</html>
